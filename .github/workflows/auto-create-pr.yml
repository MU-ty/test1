name: Auto Create PR

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Activity URL'
        required: true
        type: string
      issue_number:
        description: 'Source issue number'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Git and Create Branch
        run: |
          git config user.name "activity-bot"
          git config user.email "bot@open-source-deadlines.app"
          BRANCH_NAME="bot/activity-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
      
      - name: Prepare activity data
        run: |
          echo "" >> data/activities.yml
          echo "- title: \"Activity from Issue\"" >> data/activities.yml
          echo "  description: \"Activity extracted and added automatically\"" >> data/activities.yml
          echo "  start_date: \"2024-01-01\"" >> data/activities.yml
          echo "  end_date: \"2024-01-01\"" >> data/activities.yml
          echo "  location: \"Online\"" >> data/activities.yml
          echo "  url: \"https://github.com\"" >> data/activities.yml
          echo "  tags: [\"auto-extracted\"]" >> data/activities.yml
      
      - name: Commit and push
        run: |
          git add data/activities.yml
          git commit -m "feat: Add activity from Issue #${{ github.event.inputs.issue_number }}"
          git push origin "$BRANCH_NAME"
      
      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const branch = "${{ env.BRANCH_NAME }}";
            const url = "${{ github.event.inputs.url }}";
            const issue = ${{ github.event.inputs.issue_number }};
            
            try {
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Add activity from Issue #${issue}`,
                body: `Activity data from: ${url}`,
                head: branch,
                base: 'main'
              });
              
              console.log(`✅ PR created: ${pr.data.html_url}`);
              
              // Comment on the issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue,
                body: `✅ PR Created! [View PR](${pr.data.html_url})`
              });
            } catch (error) {
              console.error(`Error: ${error.message}`);
              throw error;
            }
